---
id: resource-controller
---

import TabItem from '@theme/TabItem'
import Tabs from '@theme/Tabs'
import CodeBlock from '@theme/CodeBlock'
import dedent from 'dedent'
import {getBasePrefix} from '@site/src/utils/getBasePrefix'

# Контроллер

`ProjectQuota controller` — это контроллер, разработанный для реализации подсчета управляемой квоты проекта.

## Архитектура

<div className="center">
  <img src={`${getBasePrefix()}/in-cloud/img/controllers/project-quota-controller.drawio.svg`} />
</div>

## Функционал

- **Пересчет коты**: предоставляет возможность пересчитывать квоту и поддерживать значения в актуальном состоянии.

## Функциональные требования

1. Публикация событий при изменении ресурсов `Instance` и `Project`:

   - При создании, изменении или удалении ресурсов типа `Instance` и `Project` должно автоматически публиковаться событие, на которое реагирует контроллер.

2. Публикация событий при изменении контролируемых ресурсов:

   - При создании, изменении или удалении ресурсов, созданных контроллером, также должно публиковаться событие, на которое контроллер реагирует.

3. Подписка контроллера на изменения созданных ресурсов:

   - Контроллер обязан подписываться на изменения всех ресурсов, которые он создает, чтобы отслеживать их состояние.

4. Запуск процесса реконсиляции при получении событий:

   - При получении любого из указанных событий должен запускаться процесс реконсиляции ресурсов.

5. Действия процесса реконсиляции при создании и изменении:

   - В ответ на события создания или изменения, процесс реконсиляции должен пересчитывать квоту основываясь на том, какая общая квота и сколько уже зарезервировали

6. Действия процесса реконсиляции при удалении:
   - В ответ на события удаления действие не требуется

## Общий процесс квотирования Project и Instance ресурсов

-	**ProjectQuota**: отвечает за общее управление лимитами ресурсов (CPU, память, хранилище) в рамках проекта.
- **Project**:  используется для задания и изменения данных о квотах, включая их описание и распределение.
-	**Instance**: конкретные потребители ресурсов, создаваемые внутри проекта, с учетом установленных квот.

1. Ресурс `ProjectQuota` автоматически создаётся на основе данных, указанных в объекте Project.
Это позволяет централизованно управлять квотами на уровне проекта, а также обеспечить соблюдение лимитов
при добавлении новых потребителей ресурсов (Instance).

2. Логика основного контроллера
-	Обработка событий:
    -	Контроллер подписан на события создания и изменения объектов Project.
    -	При срабатывании события контроллер выполняет:
        -	Проверку на наличие существующего ProjectQuota.
        -	Создание нового ресурса, если он отсутствует.
- Калькуляция ресурсов:
     -	Контроллер проверяет наличие существующих `Instance` ресурсов в namespace `Project`.
     -	Выполняет сбор данных по уже зарезервированным ресурсам.
     -	Использует внутреннюю библиотеку b-cloud **quotes_calculations** для выполнения операций:
         -	Суммирование ресурсов, зарезервированных `Instance`.
         -	Вычитание зарезервированных ресурсов из общего лимита проекта.
         -	Установление остатков доступных ресурсов.
-	Обновление статуса `ProjectQuota`:
    -	Контроллер записывает в статус `ProjectQuota`:
        -	Остаток доступных ресурсов (leftQuotas).
        -	Общий лимит проекта (limits).

3. Логика Watcher при изменениях ресурса `Instance`
-	Обработка событий:
    -	Контроллер подписан на события создания, изменения и удаления объектов Instance.
    -	При срабатывании события:
        -	Извлекает объект `Instance` и проверяет его состояние.
        -	Создаёт запросы для пересчёта ресурсов.
-	Калькуляция ресурсов:
    -	Контроллер инициирует перерасчёт зарезервированных ресурсов для связанных объектов ProjectQuota.
    -	Использует внутреннюю библиотеку b-cloud **quotes_calculations** для выполнения операций:
        -	Добавление ресурсов из новых или изменённых инстансов.
        -	Вычитание освобождённых ресурсов при удалении.
        -	Обновление остатков, доступных для других инстансов.
-	Обновление статуса `ProjectQuota`:
    -	Контроллер записывает в статус `ProjectQuota`:
       -	Остаток доступных ресурсов (leftQuotas).
       -	Общий лимит проекта (limits).

## Дочерние ресурсы

<Tabs>
  <TabItem value="RESOURCE_PROJECT">
    <CodeBlock language="yaml">
      {dedent`
            ---
            apiVersion: b-cloud.io/v1alpha
            kind: Project
            metadata:
              name: bcloud-sandbox
            spec:
              businessName: B-Cloud
              description: Тестовый проект для B-Cloud Sandbox
              prefix: bcsn
              quotas:
                k8s:
                  limits:
                    cpu: "2"
                    memory: 4000M
                  requests:
                    cpu: "1"
                    memory: 2000M
                    storage: 1G
              state: pilot
          `}
    </CodeBlock>
  </TabItem>
</Tabs>

При создании, изменении или удалении ресурсов типа `Instance` или `Project`, контроллер должен пересчитывать квоту проекта и записать остаток в блок status.

<Tabs>

    <TabItem value='ProjectQuota'>
        <CodeBlock language="yaml">
          {dedent`
            ---
            apiVersion: b-cloud.io/v1alpha
            kind: ProjectQuota
            metadata:
              name: '$\{RESOURCE_PROJECT.metadata.name}'
            spec:
              quotas:
                k8s:
                  limits:
                    cpu: '$\{RESOURCE_PROJECT.spec.quotas.k8s.limits.cpu}'
                    memory: '$\{RESOURCE_PROJECT.spec.quotas.k8s.limits.memory}'
                  requests:
                    cpu: '$\{RESOURCE_PROJECT.spec.quotas.k8s.requests.cpu}'
                    memory: '$\{RESOURCE_PROJECT.spec.quotas.k8s.requests.memory}'
                    storage: '$\{RESOURCE_PROJECT.spec.quotas.k8s.requests.storage}'
            status:
              quotasLeft:
                k8s:
                  limits:
                    cpu: 400m
                    memory: 200M
                  requests:
                    cpu: 200m
                    memory: 100M
                    storage: 1G
          `}
        </CodeBlock>
    </TabItem>

</Tabs>
