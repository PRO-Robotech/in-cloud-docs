---
title: 'Kubernetes pods/exec'
description: 'Переход pods/exec на WebSocket (GET вместо POST), влияние на RBAC и риски разрешений в Kubernetes.'
date: 2025-08-18
slug: kubernetes-pods-exec
authors: [dlputilin]
toc_min_heading_level: 2
toc_max_heading_level: 2
tags: [Kubernetes, RBAC, Security, pods/exec]
---

import Tabs from '@theme/Tabs'
import TabItem from '@theme/TabItem'
import CodeBlock from '@theme/CodeBlock'
import dedent from 'ts-dedent'
import { YamlModal } from '../src/components/YamlModal/YamlModal'
import { getBasePrefix } from '@site/src/utils/getBasePrefix'
import { YANDEX_KUBERNETES_AUDIT_POLICY } from '@site/src/constants/kubernetes/kubernetesAudt'
import './kubernetes-exec.css'

<h3>
  Kubernetes pods/exec <span style={{ color: '#1cc5ac' }}>#</span>{' '}
</h3>

<div
  style={{
    display: 'flex',
    flexWrap: 'wrap',
    alignItems: 'flex-start',
    justifyContent: 'space-between',
    gap: '30px',
    marginTop: '1.5rem',
  }}
>
  <div style={{ flex: '1 1 58%', minWidth: '280px', maxWidth: '620px' }}>
    <p>
      <code>pods/exec</code> — удобный способ выполнять команды внутри контейнера для отладки и администрирования. Но
      вот вам сходу задача: как вы считаете, насколько безопасна вот такая роль в Kubernetes, которую можно выдать
      любому пользователю, предположив абсурдную ситуацию, что ресурс Secret в кластере не используется?
    </p>
  </div>
  <div className="execImageWrapper">
    <img
      src={`${getBasePrefix()}img/blog/pod-exec-promo.png`}
      alt="pods/exec audit"
      style={{
        width: '100%',
        maxWidth: '330px',
        filter: 'drop-shadow(0 0 30px rgba(196, 202, 255, 0.2))',
        transition: 'transform 0.3s ease-in-out',
      }}
    />
  </div>
</div>

<CodeBlock language="bash">
  {dedent`
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: test-role
    rules:
      - apiGroups: [""]
        resources: ["*"]
        verbs: ["get"]
  `}
</CodeBlock>

<p>
  Если вы ответили «безопасная», то вы не одиноки — и вы предоставили бы доступ к <code>pods/exec</code> любому
  пользователю в кластере, конечно если бы создали сверху ClusterRolebinding.
</p>

{/* truncate */}

## Оглавление

- [Что изменилось](#что-изменилось)
- [Влияние на kubectl и RBAC](#влияние-на-kubectl-и-rbac)
- [Проверка на Minikube](#проверка-на-minikube)
- [Демонстрация (kubectl 1.33.3 vs 1.29.0)](#демонстрация-kubectl-1333-vs-1290)
- [Итоги и рекомендации](#итоги-и-рекомендации)

## Что изменилось

На самом деле — ничего. Проблеме уже больше 7 лет, но о ней мало кто знает. Проблема заключается в том, что в головах умных мужей укоренилась мысль, что доступ к <code>pods/exec</code> можно дать вот таким простым правилом:

<CodeBlock language="bash">
  {dedent`
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: test-role
    rules:
      - apiGroups: [""]
        resources: ["pods/exec"]
        verbs: ["create"]
  `}
</CodeBlock>

В принципе вы были бы правы, но, как показала практика — не только =)

Первое упоминание о проблеме мне помогли найти ребята из [ever_secure](https://t.me/ever_secure):

[kubernetes RBAC role verbs to exec to pod](https://stackoverflow.com/questions/48118125/kubernetes-rbac-role-verbs-to-exec-to-pod)

> I had to add the verb "get" to my pods/exec section as well since the client library I'm using is doing an http GET to negotiate a websocket first.
> Using kubectl it sends an http POST and requires the "create" verb in that case.
> It may be worth updating this example to include the "get" verb.

То есть, уже 7 лет назад был тревожный звоночек: `kubectl exec` может работать не только через POST, но и через GET.

Это окончательно подтвердилось после перехода `kubectl` на WebSocket в версии 1.31, где теперь `kubectl exec` использует **GET** для установления соединения, а не **POST** по умолчанию.

Источник: [Streaming Transitions from SPDY to WebSockets](https://kubernetes.io/blog/2024/08/20/websockets-transition/)

## Влияние на kubectl и RBAC

Чтобы понять, почему теперь нужен `get`, надо разобраться, как HTTP-методы отображаются в Kubernetes verbs:

<table>
  <thead>
    <tr>
      <th>HTTP-метод</th>
      <th>Kubernetes verb</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <code>GET</code>
      </td>
      <td>
        <code>get</code>
      </td>
    </tr>
    <tr>
      <td>
        <code>POST</code>
      </td>
      <td>
        <code>create</code>
      </td>
    </tr>
    <tr>
      <td>
        <code>PUT</code>
      </td>
      <td>
        <code>update</code>
      </td>
    </tr>
    <tr>
      <td>
        <code>DELETE</code>
      </td>
      <td>
        <code>delete</code>
      </td>
    </tr>
  </tbody>
</table>

Некоторые клиенты используют GET для установки WebSocket-соединения с pods/exec, а не POST, как kubectl. Поэтому для работы exec может потребоваться не только create, но и get в RBAC.

## Проверка на Minikube

### Кластер и контексты

<CodeBlock language="bash">
  {dedent`
    minikube -p 13201 start --kubernetes-version=1.32.1 --ssh-port=13201
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    kubectl get nodes
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    NAME     STATUS   ROLES           AGE   VERSION
    13201    Ready    control-plane   60s   v1.32.1
  `}
</CodeBlock>

### cluster-admin и anonymous

<CodeBlock language="bash">
  {dedent`
    export KUBECONFIG=cluster-admin
    minikube -p 13201 update-context
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    export KUBECONFIG=anonymous-view
    minikube -p 13201 update-context
    sed -i '/^[[:space:]]*users:/,$d' anonymous-view
  `}
</CodeBlock>

### Pod и проверки exec

<CodeBlock language="bash">
  {dedent`
    kubectl \\
      --kubeconfig=cluster-admin \\
      apply -f - <<EOF
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
    EOF
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    kubectl --kubeconfig=cluster-admin get po
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    NAME    READY   STATUS    RESTARTS   AGE
    nginx   1/1     Running   0          23s
  `}
</CodeBlock>

### exec: cluster-admin vs anonymous

<CodeBlock language="bash">
  {dedent`
    kubectl --kubeconfig=cluster-admin exec -it nginx -- sh
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    # ls -al
    total 76
    drwxr-xr-x 1 root root 4096 Aug 18 15:09 .
    drwxr-xr-x 1 root root 4096 Aug 18 15:09 ..
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    kubectl --kubeconfig=anonymous-view exec -it nginx -- sh
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    Error from server (Forbidden): pods "nginx" is forbidden: User "system:anonymous" cannot get resource "pods" in API group "" in the namespace "default"
  `}
</CodeBlock>

### Добавляем доступ только на <code>get</code>

:::note
Просьба обратить внимание, что вместе с `pods/exec` добавляется доступ к `pods`, иначе `exec` не будет работать.
:::

<CodeBlock language="bash">
  {dedent`
    kubectl \\
      --kubeconfig=cluster-admin \\
      apply -f - <<EOF
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: anonymous-view
    rules:
      - apiGroups: [""]
        resources:
          - pods
          - pods/exec
        verbs: ["get"]
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: anonymous-view
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: anonymous-view
    subjects:
      - kind: User
        name: system:anonymous
        apiGroup: rbac.authorization.k8s.io
    EOF
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    clusterrole.rbac.authorization.k8s.io/anonymous-view created
    clusterrolebinding.rbac.authorization.k8s.io/anonymous-view created
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    kubectl --kubeconfig=anonymous-view exec -it nginx -- sh
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    # ls -la
    total 76
    drwxr-xr-x 1 root root 4096 Aug 18 15:09 .
    drwxr-xr-x 1 root root 4096 Aug 18 15:09 ..
    -rwxr-xr-x 1 root root    0 Aug 18 15:09 .dockerenv
    drwxr-xr-x 2 root root 4096 Mar 26 2019 bin
    drwxr-xr-x 2 root root 4096 Feb  3 2019 boot
    drwxr-xr-x 5 root root  360 Aug 18 15:09 dev
  `}
</CodeBlock>

## Демонстрация (kubectl 1.33.3 vs 1.29.0)

<details open>
<summary>
  <div style={{ display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap' }}>
    <p style={{ marginBottom: 0 }}>kubectl v1.33.3</p>
  </div>
</summary>

<CodeBlock language="bash">
  {dedent`
    kubectl version
    Client Version: v1.33.3
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    kubectl exec -it nginx -- sh
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    ****** verb="GET" url="/api/v1/namespaces/default/pods/incloud-web-incloud-web-chart-d99877d74-27tcd/exec?command=sh&container=nginx&stdin=true&stdout=true&tty=true" ******
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    / $ ls -al
    total 76
    drwxr-xr-x 1 root root 4096 Aug 16 20:43 .
    drwxr-xr-x 1 root root 4096 Aug 16 20:43 ..
    drwxr-xr-x 2 root root 4096 Jul 15 10:42 bin
    drwxr-xr-x 5 root root  360 Aug 16 20:43 dev
  `}
</CodeBlock>
</details>

<details open>
<summary>
  <div style={{ display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap' }}>
    <p style={{ marginBottom: 0 }}>kubectl v1.29.0</p>
  </div>
</summary>

<CodeBlock language="bash">
  {dedent`
    kubectl version
    Client Version: v1.29.0
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    kubectl exec -it nginx -- sh
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    ****** POST https://api/v1/namespaces/default/pods/incloud-web-incloud-web-chart-d99877d74-27tcd/exec?command=sh&container=nginx&stdin=true&stdout=true&tty=true ******
  `}
</CodeBlock>

<CodeBlock language="bash">
  {dedent`
    Error from server (Forbidden): pods "nginx" is forbidden:
    User "system:anonymous" cannot get resource "pods" in API group "" in the namespace "default"
  `}
</CodeBlock>
</details>

:::danger Внимание!
В данном примере мы хотели бы показать поведение `kubectl exec` в разных версиях клиента. При одной и тоже конфигурации кластера и ролей. Как видно поведение отличается, и в зависимости от версии клиента может потребоваться разная RBAC конфигурация.
:::

---

<h3>Kubernetes Audit</h3>

<CodeBlock language="bash">
  {dedent`
    {
      "annotations": {
        "authorization.k8s.io/decision": "allow",
        "authorization.k8s.io/reason": "RBAC: allowed by ClusterRoleBinding \\"anonymous-view-all\\" of ClusterRole \\"anonymous-view\\" to User \\"system:anonymous\\""
      },
      "apiVersion": "audit.k8s.io/v1",
      "auditID": "142e967e-4958-4a77-b691-2f71e26ba6ec",
      "kind": "Event",
      "level": "Request",
      "objectRef": {
        "apiVersion": "v1",
        "name": "nginx",
        "namespace": "default",
        "resource": "pods",
        "subresource": "exec"
      },
      "requestURI": "/api/v1/namespaces/default/pods/nginx/exec?...",
      "responseStatus": {
        "code": 101,
        "metadata": {}
      },
      "sourceIPs": ["10.0.0.33"],
      "stage": "ResponseComplete",
      "stageTimestamp": "2025-08-15T16:46:50.296700Z",
      "user": {
        "groups": ["system:unauthenticated"],
        "username": "system:anonymous"
      },
      "userAgent": "Mozilla/5.0 (...) Safari/537.36",
      "verb": "get"
    }
  `}
</CodeBlock>

## Итоги и рекомендации

К сожалению нельзя знать все на свете, но можно стараться минимизировать риски.

Проверяйте RBAC, не доверяйте слепо ролям с `*` в `resources` и `verbs`.

<CodeBlock language="bash">
  {dedent`
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: test-role
    rules:
      - apiGroups: [""]
        resources: ["pods"]
        verbs: ["get"]
      - apiGroups: [""]
        resources: ["pods/exec"]
        verbs: ["create", "get"]
  `}
</CodeBlock>

:::danger Опасный паттерн
Лучшие политики — явные. Не используйте `*` в `resources` или `verbs`. Это спасёт вас от неожиданных сюрпризов.
:::
